---
title: Ex situ conservation assessment 
author: Report generate from the GAMMA application
output:
  html_document:
      css: style.css
date: "date: `r Sys.Date()`"
params:
  points: NULL
  pointsBuffer: NULL
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
pacman::p_load("leaflet","data.table", "tidyr", "dplyr","plotly","DT","RColorBrewer", "readr")

# source some global data 
source("utilities/loadGlobalVariables.R")


### function for control number of character after the decimal place 
sigfig <- function(vec, n=2){ 
### function to round values to N significant digits
# input:   vec       vector of numeric
#          n         integer is the required sigfig  
# output:  outvec    vector of numeric rounded to N sigfig

formatC(signif(vec,digits=n), digits=n,format="fg", flag="#") 

} 
```


```{r, echo=FALSE, message=FALSE, warning=FALSE} 
# processing steps for map 
points <- params$points
pointBuffer <- params$pointsBuffer

h_buffer <- terra::aggregate(
    pointBuffer[pointBuffer$`Current Germplasm Type` == "H", ]
  )
#G points 
g_buffer<- terra::aggregate(
    pointBuffer[pointBuffer$`Current Germplasm Type` == "G", ]
  )
# print(nrow(h_buffer))
# 
# 
# print(unique(g_buffer$`Current Germplasm Type`))
```


# What to show 

# written summary of the results 

# Map 
```{r, echo=FALSE, message=FALSE, warning=FALSE}

# inital map for gap analysis page
map2 <-  leaflet(options = leafletOptions(minZoom = 3, maxZoom = 16)) |>
    addProviderTiles("OpenStreetMap", group = "OpenStreetMap") |>
    addProviderTiles("Esri.WorldTopoMap", group = "Topography") |>
    addProviderTiles("Esri.WorldImagery", group = "Imagery")|>
    addLayersControl(
      position = "topleft",
      overlayGroups = c("Reference Records",
                        "Germplasm Records",
                        "Buffers",
                        "GRS gaps",
                        "ERS gaps"),
      baseGroups = c("OpenStreetMap",
                     "Topography",
                     "Imagery"),
      options = layersControlOptions(collapsed = FALSE)
    )|>
    hideGroup(c("GRS gaps","ERS gaps")) |> # keeping enabled for now
    addMapPane("ersGap", zIndex = 400) |>  # Lower zIndex for polygons
    addMapPane("grsGap", zIndex = 405) |>
    addMapPane("allBuffers", zIndex = 410) |>
    addMapPane("pointsH", zIndex = 415) |>   # Higher zIndex for points1
    addMapPane("pointsG", zIndex = 420) |>
    addLegend(
      position = "topright",
      colors = gbif_GapMap,
      labels = c("GBIF Reference", "GBIF Germplasm")
    )|>
    addLegend(
      position = "topright",
      colors = upload_GapMap,
      labels = c("Upload Reference", "Upload Germplasm")
    )

# Add points 
map2a <- map2 |>
      addPolygons(data = h_buffer,
                  group = "Buffers",
                  color = combinedColor[1],
                  fillOpacity = 0.5,
                  options = pathOptions(pane = "allBuffers"))|>
      addPolygons(data = g_buffer,
                  group = "Buffers",
                  color = combinedColor[2],
                  fillOpacity = 0.5,
                  options = pathOptions(pane = "allBuffers"))

# Add buffers 


# Add grsex 


# add ersex 



map2a
```

# Table of gap analysis Data 


```{r, echo=FALSE, message=FALSE, warning=FALSE}
p1 <- params$points
data.table(p1)
```

## Definitions of conservation gap analysis scores

### Sampling Representativeness Score (SRS)

**Ex situ**: The Sampling Representativeness Score *ex situ* (SRS ex situ) calculates the ratio of germplasm accessions (G) available in *ex situ* repositories to reference/voucher (H) records for each taxon, making use of all compiled records irrespective of whether they include coordinates.

### Geographic Representativeness Score (GRS)

**Ex situ**: The Geographic Representativeness Score *ex situ* (GRS ex situ) uses a user defined km-radius buffers created around each G collection coordinate point to estimate geographic areas already well collected within the potential distribution models of each taxon and then calculates the proportion of the potential distribution model covered by these buffers.

### Ecological Representativeness Score (ERS)

**Ex situ**: The Ecological Representativeness Score *ex situ* (ERS ex situ) calculates the proportion of terrestrial ecoregions represented within the G buffered areas out of the total number of ecoregions occupied by the potential distribution model.


### Final Conservation Score (FCS)

**Ex situ**: The Final Conservation Score *ex situ* (FCS ex situ) was derived by calculating the average of the three *ex situ* conservation metrics.

Taxa were further categorized with regard to the two conservation strategies as well as in combination, with Urgent Priority (UP) for further conservation action assigned when FCS < 25, High Priority (HP) assigned when 25 ≤ FCS < 50, Medium Priority (MP) when 50 ≤ FCS < 75, and Low Priority (LP) when FCS ≥75.

