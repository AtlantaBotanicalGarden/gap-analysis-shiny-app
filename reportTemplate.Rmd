---
title: Ex situ conservation assessment 
author: Report generate from the GAMMA application
output:
  html_document:
      css: style.css
date: "date: `r Sys.Date()`"
params:
  points: NULL
  pointsBuffer: NULL
  ersex: NULL 
  grsex: NULL
  srsScore: NULL
  ersScore: NULL
  grsScore: NULL
  bufferDist: NULL
---

```{=html}
<style type="text/css">
.main-container {
  max-width: 2800px;
  margin-left: auto;
  margin-right: auto;
}
</style>
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
pacman::p_load("leaflet","data.table", "tidyr", "dplyr","plotly","DT","RColorBrewer", "readr")

# source some global data 
source("utilities/loadGlobalVariables.R")
# adding paths to the image features 

### function for control number of character after the decimal place 
sigfig <- function(vec, n=2){ 
### function to round values to N significant digits
# input:   vec       vector of numeric
#          n         integer is the required sigfig  
# output:  outvec    vector of numeric rounded to N sigfig

formatC(signif(vec,digits=n), digits=n,format="fg", flag="#") 

} 
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# processing steps for map 
points <- params$points
pointBuffer <- params$pointsBuffer
ersex <- params$ersex 
grsex <- params$grsex
srsScore <- params$srsScore
ersScore <- params$ersScore
grsScore <- params$grsScore
bufferDist <- params$bufferDist
# process points layers 
# spilt out the G and H points
# assign icon for visualization 
points <- points |>
  dplyr::mutate(
    # icon = dplyr::case_when(
    #   `Current Germplasm Type` == "G" & source == "GBIF" ~ icon_paths$g_gbif, # Use & for vectorized AND
    #   `Current Germplasm Type` == "H" & source == "GBIF" ~ icon_paths$h_gbif, # Use & for vectorized AND
    #   `Current Germplasm Type` == "G" & source == "upload" ~ icon_paths$g_upload, # Corrected source name
    #   `Current Germplasm Type` == "H" & source == "upload" ~ icon_paths$h_upload, # Corrected source name
    #   TRUE ~ "default_icon" # Optional: Default icon if no conditions match
    # ),
    color = case_when(
          `Current Germplasm Type` == "H" ~ combinedColor[1],
          `Current Germplasm Type` == "G" ~ combinedColor[2]
        )
  )
## G
gGap <- points |>
    dplyr::filter(`Current Germplasm Type` == "G")
gLabels <- lapply(gGap$popup, htmltools::HTML)
## H
hGap <- points |>
    dplyr::filter(`Current Germplasm Type` == "H")
hLabels <- lapply(hGap$popup, htmltools::HTML)


# h buffers
h_buffer <- terra::aggregate(
    pointBuffer[pointBuffer$`Current Germplasm Type` == "H", ]
  )
#G buffers  
g_buffer<- terra::aggregate(
    pointBuffer[pointBuffer$`Current Germplasm Type` == "G", ]
  )

# generate the written summary 
srs <- as.numeric(srsScore) |> round(digits = 2)
grs <- as.numeric(grsScore) |> round(digits = 2)
ers <- as.numeric(ersScore) |> round(digits = 2)
totalPoints <- nrow(points)
referncePoints <- nrow(points[points$`Current Germplasm Type` == "H",])
germplasmPoints <- nrow(points[points$`Current Germplasm Type` == "G",])
species <- points$`Taxon Name`[1]

```

# Summary of results for `r  species` 

The gap analysis was conducted using a total of `r totalPoints` observations. Of these `r germplasmPoints` were germplasm records and `r referncePoints` were reference records.

The relationship between these observation types is recorded by the the Sampling Representativeness Score : `r srs`.

Evaluating the spatial relationship of these observations at a buffer distance of `r bufferDist` km resulted in a Geographic representativeness score of `r grs` and a ecological representativeness score of `r ers`.

# Map 

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}
# inital map for gap analysis page
map2 <-  leaflet(options = leafletOptions(minZoom = 3, maxZoom = 16)) |>
    addProviderTiles("OpenStreetMap", group = "OpenStreetMap") |>
    addProviderTiles("Esri.WorldTopoMap", group = "Topography") |>
    addProviderTiles("Esri.WorldImagery", group = "Imagery")|>
    addLayersControl(
      position = "topleft",
      overlayGroups = c("Reference Records",
                        "Germplasm Records",
                        "Buffers",
                        "GRS gaps",
                        "ERS gaps"),
      baseGroups = c("OpenStreetMap",
                     "Topography",
                     "Imagery"),
      options = layersControlOptions(collapsed = FALSE)
    )|>
    hideGroup(c("GRS gaps","ERS gaps")) |> # keeping enabled for now
    addMapPane("ersGap", zIndex = 400) |>  # Lower zIndex for polygons
    addMapPane("grsGap", zIndex = 405) |>
    addMapPane("allBuffers", zIndex = 410) |>
    addMapPane("pointsH", zIndex = 415) |>   # Higher zIndex for points1
    addMapPane("pointsG", zIndex = 420) |>
    # add point objects
    addCircleMarkers(
        data = hGap,
        group = "Reference Records",
        radius = 4,
        color = "white",
        fillColor = ~color,
        stroke = TRUE,
        weight = 1,
        fillOpacity = 1,
        label = hLabels
      ) |>
    addCircleMarkers(
        data = gGap,
        group = "Germplasm Records",
        radius = 4,
        color = "white",
        fillColor = ~color,
        stroke = TRUE,
        weight = 1,
        fillOpacity = 1,
        label = gLabels
      )|>
  # add buffer objects
      addPolygons(data = h_buffer,
                  group = "Buffers",
                  color = combinedColor[1],
                  fillOpacity = 0.5,
                  options = pathOptions(pane = "allBuffers"))|>
      addPolygons(data = g_buffer,
                  group = "Buffers",
                  color = combinedColor[2],
                  fillOpacity = 0.5,
                  options = pathOptions(pane = "allBuffers"))|>
      #add grs map
      clearGroup("GRS gaps")|>
      addPolygons(data = grsex,
                  group = "GRS gaps",
                  color = grsexColor,
                  fillOpacity = 0.5,
                  options = pathOptions(pane = "grsGap")) |>
      # add ersex map
      addPolygons(data = ersex_missingEcos(),
                  group = "ERS gaps",
                  color = ersexColor,
                  fillOpacity = 0.5,
                  popup = ~ECO_NAME,
                  options = pathOptions(pane = "ersGap"))|>
    # add all legends
    ## legends for unique icons by sources 
    # addLegend(
    #     position = "topright",
    #     colors = gbif_GapMap,
    #     labels = c("GBIF Reference", "GBIF Germplasm")
    #   )|>
    #   addLegend(
    #     position = "topright",
    #     colors = upload_GapMap,
    #     labels = c("Upload Reference", "Upload Germplasm")
    #   )|>
    addLegend(
        position = "topright",
        # group = "GRS gaps",
        colors = combinedColor,
        labels = c("Reference", "Germplasm")
      )|>
      addLegend(
        position = "topright",
        group = "GRS gaps",
        colors = grsexColor,
        labels = c("GRS gaps")
      )|>
      addLegend(
        position = "topright",
        group = "ERS gaps",
        colors = ersexColor,
        labels = c("ERS gaps")
      )


map2
```

# Table of gap analysis Data

The following table contains all the locality information that was used to generate the gap analysis results.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
colSelect <- points |>
  as.data.frame()|>
  dplyr::select(
    `Accession Number`,
    `Taxon Name`,
    `Current Germplasm Type`,
    `Collection Date` ,
    `source`,
    `Locality`,
    `Collector`,
    `Latitude` ,
    "Longitude"
  )

DT::datatable(colSelect,
              rownames = FALSE)
```

## Definitions of conservation gap analysis scores

### Sampling Representativeness Score (SRS)

**Ex situ**: The Sampling Representativeness Score *ex situ* (SRS ex situ) calculates the ratio of germplasm accessions (G) available in *ex situ* repositories to reference/voucher (H) records for each taxon, making use of all compiled records irrespective of whether they include coordinates.

### Geographic Representativeness Score (GRS)

**Ex situ**: The Geographic Representativeness Score *ex situ* (GRS ex situ) uses a user defined km-radius buffers created around each G collection coordinate point to estimate geographic areas already well collected within the potential distribution models of each taxon and then calculates the proportion of the potential distribution model covered by these buffers.

### Ecological Representativeness Score (ERS)

**Ex situ**: The Ecological Representativeness Score *ex situ* (ERS ex situ) calculates the proportion of terrestrial ecoregions represented within the G buffered areas out of the total number of ecoregions occupied by the potential distribution model.

### Final Conservation Score (FCS)

**Ex situ**: The Final Conservation Score *ex situ* (FCS ex situ) was derived by calculating the average of the three *ex situ* conservation metrics.

Taxa were further categorized with regard to the two conservation strategies as well as in combination, with Urgent Priority (UP) for further conservation action assigned when FCS \< 25, High Priority (HP) assigned when 25 ≤ FCS \< 50, Medium Priority (MP) when 50 ≤ FCS \< 75, and Low Priority (LP) when FCS ≥75.
